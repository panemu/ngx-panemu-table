<div class="panemu-table">
  <panemu-busy-indicator *ngIf="loading | async"></panemu-busy-indicator>
  
  <div [class.v-scrollable]="verticalScroll" style="overflow: auto;">
    <table #panemuTable class="table">
      <colgroup>
        @for (column of _visibleColumns; track $index) {
          <col [attr.data-col]="'th_' + column.__key" [style.width]="column.width ? (column.width + 'px') : null"/>
        }
      </colgroup>
      <thead >
        @for (header of columnDefinition.header; track header) {
          <tr>
            @for (cell of header.cells; track cell.__key; let idx = $index) {
              <ng-container *ngIf="cell.resizable; else notResizable">
                <th class="default-header" 
                  [attr.data-col]="'th_' + cell.__key!" 
                  [attr.group]="cell.__isGroup"
                  [attr.rowspan]="cell.__rowSpan" 
                  [attr.colspan]="cell.__colSpan" 
                  [resizable]="cell.width!" 
                  [columnId]="'th_' + cell.__key!" 
                  [ngClass]="{'sticky-start': cell.sticky == 'start', 'sticky-end': cell.sticky == 'end'}"
                  [table]="matTable">
                  <ng-container [ngTemplateOutlet]="columnHeader" [ngTemplateOutletContext]="{column : cell}"></ng-container>
                </th>
              </ng-container>
              <ng-template #notResizable>
                <th class="default-header" 
                  [attr.data-col]="'th_' + cell.__key!"
                  [attr.group]="cell.__isGroup"
                  [attr.rowspan]="cell.__rowSpan" 
                  [attr.colspan]="cell.__colSpan" 
                  [ngClass]="{'sticky-start': cell.sticky == 'start', 'sticky-end': cell.sticky == 'end'}"
                  >
                  <ng-container [ngTemplateOutlet]="columnHeader" [ngTemplateOutletContext]="{column: cell}"></ng-container>
                </th>
              </ng-template>
            }
          </tr>
        }
      </thead>
      <tbody>
        @for (row of dataSource; track row) {

          @if (isGroup($index, row)) {

            <tr >
              <ng-template [rowGroupRenderer]="$any(row).column.rowGroupRenderer" [rowGroup]="$any(row)" [colSpan]="_displayedColumns.length" [expandAction]="groupHeaderClick.bind(this)"></ng-template>
            </tr>

          } @else if (isExpansionRow($index, row)) {

            <tr>
              <td [attr.colspan]="_displayedColumns.length">
                @if($any(row).isTemplateRef()) {
                  <ng-container 
                  [ngTemplateOutlet]="$any(row).component()" 
                  [ngTemplateOutletContext]="{row: $any(row).row, column: $any(row).column, close: $any(row).close.bind($any(row))}">

                  </ng-container>
                } @else {
                  <ng-template 
                    [expansionRowRenderer]="$any(row).component" 
                    [row]="$any(row).row" 
                    [column]="$any(row).column" 
                    [close]="$any(row).close.bind($any(row))">
                  </ng-template>
                }
              </td>
            </tr>

          } @else {

            <tr class="row {{row | rowStyling:rowOptions.rowClass}}"
            [style]="row | rowStyling:rowOptions.rowStyle"
            [class.selected-row]="_controllerSelectedRowSignal() == row" 
            (click)="selectRow($any(row))">

              @for (column of _visibleColumns; track column) {

                <td 
                  class="default-cell {{column.__key!}} {{$any(row)[column.field] | cellStyling:row:column.cellClass}}" 
                  [style]="$any(row)[column.field] | cellStyling:row:column.cellStyle"
                  [ngClass]="{'sticky-start': column.sticky == 'start', 'sticky-end': column.sticky == 'end'}"
                  >
                  <ng-template [cellRenderer]="column" [row]="row" ></ng-template>
                </td>
              }
            </tr>

          }
          
        }
      </tbody>
      
      
    </table>
  </div>
  <div class="no-data" *ngIf="controller() && !dataSource?.length"> {{labelTranslation.noData}} </div>
</div>

<ng-template #columnHeader let-column="column">
  <div class="column-header" [class.sortable]="column.sortable" (click)="sort(column)">
    <ng-template [headerRenderer]="column" ></ng-template>
    <span *ngIf="controller().sortedColumn[column.field]" class="material-symbols-outlined">
      {{controller().sortedColumn[column.field] == 'asc' ? 'arrow_drop_down' : 'arrow_drop_up'}}
    </span>
  </div>
</ng-template>